/* filename: init.S */
.thumb
.syntax unified
.word 0x20010000
.word RESET_HANDLER
.word DEFAULT_HANDLER
/* The 4 Faults minus the "It's not My" */
.word FAULT_HANDLER
.word FAULT_HANDLER
.word FAULT_HANDLER
.word FAULT_HANDLER

/*The 5 Reserved things*/
.word DEFAULT_HANDLER
.word DEFAULT_HANDLER
.word DEFAULT_HANDLER
.word DEFAULT_HANDLER
.word DEFAULT_HANDLER

/*Supervisor call, Debug Monitor, reserved, and service call*/
.word DEFAULT_HANDLER
.word DEFAULT_HANDLER
.word DEFAULT_HANDLER
.word SYSTICK_HANDLER

.word DEFAULT_HANDLER
.word DEFAULT_HANDLER
.word DEFAULT_HANDLER
.word DEFAULT_HANDLER
.word DEFAULT_HANDLER
.word DEFAULT_HANDLER
.word EXTI0_HANDLER


.global RESET_HANDLER
.type RESET_HANDLER, %function
.type FAULT_HANDLER, %function
.type DEFAULT_HANDLER, %function
.type SYSTICK_HANDLER, %function
.type EXTI0_HANDLER, %function

/* lights */
.equ GPIOD_MODER, 0x40020C00
.equ GPIOD_IDR, 0x40020C10
.equ GPIOD_ODR, 0x40020C14
.equ GPIOD_BSRR, 0x40020C18
.equ RCC_AHB1ENR, 0x40023830
/* Systick */
.equ SYSTICK_CTRL, 0xE000E010
.equ SYSTICK_LOAD, 0xE000E014

/* exti */
.equ EXTI_IMR, 0x40013C00
.equ EXTI_RTSR, 0x40013C08
.equ EXTI_PR, 0x40013C14

/* NVIC */
.equ NVIC_ISER0, 0xE000E100

RESET_HANDLER:
  BL LED_INIT
  BL SYSTICK_INIT
  BL BUTTON_INIT
  B STATE_MACHINE
 /*MOV R0, #11 MOV PC, R0 */


LED_INIT:
  PUSH {R0,R1,R2,R3,LR}
  MOV R0, #1

  LDR R1, =RCC_AHB1ENR
  LDR R3, [R1]
  LSL R2, R0, #3
  ORR R2, R3, R2
  STR R2, [R1]

  /* init Green and Red LEDs*/
  MOV R0, #0b01010101
  LDR R1, =GPIOD_MODER
  LSL R2, R0, #24
  STR R2, [R1]
  POP {R0,R1,R2,R3,PC}

SYSTICK_INIT:
  PUSH {R1,R2,R3,LR}
  LDR R1, =SYSTICK_CTRL
  LDR R3, [R1]
  MOV R2, #0x7
  ORR R2, R3, R2
  STR R2, [R1]

  LDR R1, =SYSTICK_LOAD
  LDR R3, [R1]
  MOVW R2, #0x11FF
  MOVT R2, #0x7A
  ORR R2, R3, R2
  STR R2, [R1]
  POP {R1,R2,R3,PC}

BUTTON_INIT:
  PUSH {R0-R3,LR}
  MOV R0, #1
  LDR R1, =RCC_AHB1ENR
  LDR R2, [R1]
  ORR R2, R2, R0
  STR R2, [R1]

  MOV R0, #1
  LDR R1, =EXTI_RTSR
  LDR R2, [R1]
  ORR R2, R2, R0
  STR R2, [R1]

  MOV R0, #1
  LDR R1, =EXTI_IMR
  LDR R2, [R1]
  ORR R2, R2, R0
  STR R2, [R1]


  MOV R0, #1
  LSL R1, R0, #6
  LDR R2, =NVIC_ISER0
  STR R1, [R2]

  POP {R0-R3,PC}

STATE_MACHINE:
  CMP R11, #0x0
  BEQ STATE0
  CMP R11, #0x1
  BEQ STATE1
  CMP R11, #0x2
  BEQ STATE2
  CMP R11, #0x3
  BEQ STATE3
  CMP R11, #0x3
  BGT STATE_ERR
  B STATE_MACHINE

STATE0:
  PUSH {R0,R1,R2,R3}
  MOV R0, #1
  LSL R2, R0, #12
  LDR R1, =GPIOD_ODR
  LDR R3, [R1]
  AND R2, R3, R2
  STR R2, [R1]
  POP {R0,R1,R2,R3}
  B STATE_MACHINE

STATE1:
  PUSH {R0,R1,R2,R3}
  MOV R0, #0xA000
  LDR R1, =GPIOD_ODR
  LDR R3, [R1]
  ORR R2, R3, R0
  MOVW R0, #0xd000
  AND R2, R0
  STR R2, [R1]
  POP {R0,R1,R2,R3}
  B STATE_MACHINE

STATE2:
  PUSH {R0,R1,R2,R3}
  MOV R0, #0xA000
  LDR R1, =GPIOD_ODR
  LDR R3, [R1]
  ORR R2, R3, R0
  MOVW R0, #0x7000
  AND R2, R0
  STR R2, [R1]
  POP {R0,R1,R2,R3}
  B STATE_MACHINE

STATE3:
  PUSH {R0,R1,R2,R3}
  MOV R0, #0xA000
  MOVT R0, #0xFFFF
  LDR R1, =GPIOD_ODR
  LDR R3, [R1]
  ORR R2, R3, R0
  STR R2, [R1]
  POP {R0,R1,R2,R3}
  B STATE_MACHINE

STATE_ERR:
  B FAULT_HANDLER

LED_TOGGLE_GREEN:
  PUSH {R0,R1,R2,R3,LR}
  MOV R0, #1
  LDR R1, =GPIOD_ODR
  LDR R3, [R1]
  LSL R2, R0, #12
  EOR R2, R3, R2
  STR R2, [R1]
  POP {R0,R1,R2,R3,PC}

DEFAULT_HANDLER:
  B FOREVER

FAULT_HANDLER:
 BL LED_INIT
 MOV R0, #1
 LDR R1, =GPIOD_BSRR
 LDR R3, [R1]
 LSL R2, R0, #14
 ORR R2, R3, R2
 STR R2, [R1]
 B FOREVER

EXTI0_HANDLER:
  PUSH {R0,R1,LR}
  MOV R0, #1
  LDR R1, =EXTI_PR
  EOR R0, R1
  STR R0,[R1]
  ADD R11,#1
  AND R11,#3
  POP {R0,R1,PC}

SYSTICK_HANDLER:
  PUSH {LR}
  BL LED_TOGGLE_GREEN
  POP {PC}

FOREVER:
  B FOREVER
.end
